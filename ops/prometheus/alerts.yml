groups:
  - name: splendoura-backend-alerts
    rules:
      - alert: SplendouraHigh5xxRate
        expr: |
          (
            sum(rate(splendoura_http_requests_total{status_code=~"5.."}[5m]))
            /
            clamp_min(sum(rate(splendoura_http_requests_total[5m])), 0.001)
          ) > 0.05
        for: 10m
        labels:
          severity: warning
          service: backend
        annotations:
          summary: "High 5xx rate on backend"
          description: "5xx error rate has been above 5% for 10 minutes."

      - alert: SplendouraHighP95Latency
        expr: |
          histogram_quantile(
            0.95,
            sum by (le) (rate(splendoura_http_request_duration_seconds_bucket[5m]))
          ) > 1
        for: 10m
        labels:
          severity: warning
          service: backend
        annotations:
          summary: "High p95 latency on backend"
          description: "P95 latency has been above 1 second for 10 minutes."

      - alert: SplendouraRequestSpike
        expr: |
          (
            sum(rate(splendoura_http_requests_total[5m]))
            >
            3 * sum(rate(splendoura_http_requests_total[5m] offset 1h))
          )
          and
          sum(rate(splendoura_http_requests_total[5m])) > 5
        for: 5m
        labels:
          severity: info
          service: backend
        annotations:
          summary: "Request spike detected"
          description: "Traffic is >3x compared to one hour ago."
